#!/usr/bin/env bash

# This script is designed to be platform agnostic, but primarily
# for MacOS and Debian systems. It will install dependencies and
# tools for a first time install, and link some configs.

#####################
# Basic Environment #
#####################

# Check if the script is run as root
if [ "$(id -u)" -eq 0 ]; then
    echo "This script should not be run as root. Exiting..."
    exit 1
fi

# Set up some variables for the script
DOTFILES=$(cd "$(dirname "$0")" && pwd)
CONFIG_HOME="${XDG_CONFIG_HOME:-$HOME/.config}"
PLATFORM=$(uname -s)
RELEASE=$(lsb_release -i | cut -f 2-)


#############
# Functions #
#############

# Run platform specific installation scripts
run_install() {
    echo "Checking platform..."
    if [ "$PLATFORM" = "Darwin" ]; then
        echo "MacOS detected."
        (sh ./install_mac)
    elif [ "$PLATFORM" = "Linux" ] && [ "$RELEASE" = "Debian" ]; then
        echo "Debian detected."
        (bash ./install_debian)
    else
        echo "Unsupported platform. Can't continue installation. Exiting..."
        exit 1
    fi
}

# Backup a config directory if it already exists
backup_config() {
    if [ -d "${CONFIG_HOME:?}/$1" ]; then
        mkdir -p "$HOME/.backups/$1"
        mv "$CONFIG_HOME/$1" "$HOME/.backups/$1"
    fi
    return 0
}

# Link some configs
link_configs() {
    # Ansible
    echo "Linking Ansible config..."
    backup_config "ansible"
    ln -sf "$DOTFILES/ansible" "$CONFIG_HOME/ansible"

    # Bat
    echo "Linking Bat config..."
    backup_config "bat"
    ln -sf "$DOTFILES/bat" "$CONFIG_HOME/bat"

    # Cursor
    echo "Linking Cursor config..."
    backup_config "cursor"
    ln -sf "$DOTFILES/cursor" "$CONFIG_HOME/cursor"

    # Eza
    echo "Linking Eza config..."
    backup_config "eza"
    ln -sf "$DOTFILES/eza" "$CONFIG_HOME/eza"

    # Fish - NOT BEING USED
    # echo "Linking Fish config..."
    # backup_config "fish"
    # ln -sf "$DOTFILES/fish" "$CONFIG_HOME/fish"

    # Fzf
    echo "Linking Fzf config..."
    backup_config "fzf"
    ln -sf "$DOTFILES/fzf" "$CONFIG_HOME/fzf"

    # Ghostty
    if [ "$PLATFORM" = "Darwin" ]; then
        echo "Linking Ghostty config..."
        backup_config "ghostty"
        ln -sf "$DOTFILES/ghostty" "$CONFIG_HOME/ghostty"
    fi

    # Git
    echo "Linking Git config..."
    backup_config "git"
    ln -sf "$DOTFILES/git" "$CONFIG_HOME/git"

    # Kitty
    echo "Linking Kitty config..."
    backup_config "kitty"
    ln -sf "$DOTFILES/kitty" "$CONFIG_HOME/kitty"

    # Neovim
    echo "Linking Neovim config..."
    backup_config "nvim"
    ln -sf "$DOTFILES/nvim" "$CONFIG_HOME/nvim"

    # Starship - NOT BEING USED
    # echo "Linking Starship config..."
    # backup_config "starship"
    # ln -sf "$DOTFILES/starship" "$CONFIG_HOME/starship"

    # TLDR/TLRC
    echo "Linking TLDR config..."
    backup_config "tldr"
    ln -sf "$DOTFILES/tldr" "$CONFIG_HOME/tldr"

    # Tmux
    echo "Linking Tmux config..."
    backup_config "tmux"
    ln -sf "$DOTFILES/tmux" "$CONFIG_HOME/tmux"

    # VS Code
    echo "Linking VS Code config..."
    backup_config "vscode"
    ln -sf "$DOTFILES/vscode" "$CONFIG_HOME/vscode"

    # ZSH
    echo "Linking ZSH config..."
    backup_config "zsh"
    ln -sf "$DOTFILES/zsh/.zshenv" "$HOME/.zshenv"
}


###############
# Main Script #
###############

echo "Starting installation..."
run_install
link_configs

# Scripts
echo "Linking custom bin scripts..."
if [ -d "$HOME/.local/bin" ]; then
    mkdir -p "$HOME/.backups/bin"
    mv "$HOME/.local/bin" "$HOME/.backups/bin"
fi
ln -sf "$DOTFILES/bin" "$HOME/.local/bin"

echo "Installation complete!"
